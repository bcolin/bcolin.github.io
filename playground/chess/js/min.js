// @preserve Author: Benoit Colin - @license BY-NC 4.0
var bchess={whiteToPlay:!0,turnCount:-1,isWorking:!1,start:function(){this.worker=new Worker("js/worker.min.js"),this.worker.addEventListener("message",this.onWorkerMessage),this.progressbar=document.getElementById("progressbar"),document.getElementById("uitypeswitch").onclick=this.onUITypeClick,document.getElementById("endgame").style.display="none",document.getElementById("endgame").style.display="none",this.resetBoard(),this.setUIType("2d")},resetBoard:function(){this.board={};for(var e=-2;e<10;e++){this.board[e]={};for(var t=-2;t<10;t++)this.board[e][t]=0<=e&&e<8&&0<=t&&t<8?{type:"empty"}:null}this.addPiece(0,1,"pion",!1),this.addPiece(1,1,"pion",!1),this.addPiece(2,1,"pion",!1),this.addPiece(3,1,"pion",!1),this.addPiece(4,1,"pion",!1),this.addPiece(5,1,"pion",!1),this.addPiece(6,1,"pion",!1),this.addPiece(7,1,"pion",!1),this.addPiece(0,0,"tour",!1),this.addPiece(7,0,"tour",!1),this.addPiece(1,0,"cheval",!1),this.addPiece(6,0,"cheval",!1),this.addPiece(2,0,"fou",!1),this.addPiece(5,0,"fou",!1),this.addPiece(3,0,"dame",!1),this.addPiece(4,0,"roi",!1),this.addPiece(0,6,"pion",!0),this.addPiece(1,6,"pion",!0),this.addPiece(2,6,"pion",!0),this.addPiece(3,6,"pion",!0),this.addPiece(4,6,"pion",!0),this.addPiece(5,6,"pion",!0),this.addPiece(6,6,"pion",!0),this.addPiece(7,6,"pion",!0),this.addPiece(0,7,"tour",!0),this.addPiece(7,7,"tour",!0),this.addPiece(1,7,"cheval",!0),this.addPiece(6,7,"cheval",!0),this.addPiece(2,7,"fou",!0),this.addPiece(5,7,"fou",!0),this.addPiece(3,7,"dame",!0),this.addPiece(4,7,"roi",!0)},compute:function(e){this.isWorking=!0,this.worker.postMessage({command:"compute",board:this.board,turnCount:this.turnCount})},onWorkerMessage:function(e){var t=e.data;if("result"==t.command){console.log(t),bchess.progressbar.style.opacity=0,bchess.progressbar.style.width=0;var i=t.bestMove;i?bchess.ui.animateMove(i.piece,i,function(){bchess.isWorking=!1,bchess.board[i.x][i.y]=JSON.parse(JSON.stringify(bchess.board[i.piece.x][i.piece.y])),bchess.board[i.piece.x][i.piece.y]={type:"empty"},bchess.draw(),bchess.setTurn(!0)}):(document.getElementById("endgame").style.display="block",document.getElementById("endgametext").innerHTML="You win :)")}else if("progress"==t.command)bchess.isWorking=!0,bchess.progressbar.style.opacity=1,bchess.progressbar.style.width=2+100*t.progress+"%";else if("canmoveresult"==t.command)if(t.value){function n(){bchess.board[t.to.x][t.to.y]=JSON.parse(JSON.stringify(bchess.board[t.from.x][t.from.y])),bchess.board[t.to.x][t.to.y].x=t.to.x,bchess.board[t.to.x][t.to.y].y=t.to.y,bchess.board[t.from.x][t.from.y]={type:"empty"},bchess.ui.doMove(t.from,t.to),bchess.draw(),bchess.setTurn(!1)}var a=bchess.board[t.from.x][t.from.y];"roi"==a.type&&a.white&&4==t.from.x&&6==t.to.x&&7==t.from.y?bchess.ui.animateMove({x:7,y:7},{x:5,y:7},function(){bchess.board[5][7]=JSON.parse(JSON.stringify(bchess.board[7][7])),bchess.board[5][7].x=5,bchess.board[5][7].y=7,bchess.board[7][7]={type:"empty"},n()}):"roi"==a.type&&a.white&&4==t.from.x&&2==t.to.x&&7==t.from.y?bchess.ui.animateMove({x:0,y:7},{x:3,y:7},function(){bchess.board[3][7]=JSON.parse(JSON.stringify(bchess.board[1][7])),bchess.board[3][7].x=3,bchess.board[3][7].y=7,bchess.board[1][7]={type:"empty"},n()}):n()}else bchess.ui.reset(),bchess.draw(),bchess.setTurn(!0);else"iswhitematresult"==t.command&&t.value&&(document.getElementById("endgame").style.display="block",document.getElementById("endgametext").innerHTML="I win :)")},addPiece:function(e,t,i,n){this.board[e][t]={type:i,white:n}},requestUserMove:function(e,t){bchess.worker.postMessage({command:"canmove",board:bchess.board,from:e,to:t})},setTurn:function(e){this.whiteToPlay=e,this.turnCount++,this.ui.setTurn(e),e?this.worker.postMessage({command:"iswhitemat",board:this.board}):this.compute()},onUITypeClick:function(){bchess.isWorking||("2d"==bchess.uiType?bchess.setUIType("3d"):bchess.setUIType("2d"))},setUIType:function(e,t){this.uiType=e,this.ui="2d"==e?h:s,window.onresize=this.ui.layout,this.ui.load(function(){bchess.ui.layout(),bchess.ui.reset(),bchess.ui.draw(),bchess.ui.setTurn(bchess.whiteToPlay),t&&t()}),document.getElementById("uitypeswitch").className="switchcontainer "+("3d"==e?"checked":"")},draw:function(){this.ui.draw(this)},onNewGameClick:function(){document.getElementById("endgame").style.display="none",bchess.resetBoard(),bchess.draw(),bchess.setTurn(!0)},onTitleClick:function(){bchess.isInfoPaneVisible=!bchess.isInfoPaneVisible;var e=document.getElementById("infopane");e.style.opacity=bchess.isInfoPaneVisible?1:0,e.style.transform=bchess.isInfoPaneVisible?"translateY(0)":"translateY(100%)",e.style.pointerEvents=bchess.isInfoPaneVisible?"all":"none"}},h={load:function(e){document.getElementById("ui2d").style.display="block",document.getElementById("scene").style.display="none",this.cbElm=document.getElementById("cb"),this.progressElm=document.getElementById("progress");var t=this;this.cbElm.ondragover=function(e){e.preventDefault()},this.cbElm.ondrop=function(e){t.onDrop(e)},this.layout(),e()},onDrop:function(e){e.preventDefault();var t=e.dataTransfer.getData("text");if(t){var i=JSON.parse(t),n=parseInt(i.x),a=parseInt(i.y),o=e.currentTarget.getBoundingClientRect(),s=Math.floor((e.pageX-o.left)/(e.currentTarget.clientWidth/8)),r=Math.floor((e.pageY-o.top)/(e.currentTarget.clientHeight/8));bchess.requestUserMove({x:n,y:a},{x:s,y:r})}},draw:function(e){this.cbElm.innerHTML="";for(var t=h.cbsize/8,i=0;i<8;i++)for(var n=0;n<8;n++){var a=bchess.board[i][n];if("empty"!=a.type){var o=document.createElement("div");o.innerHTML="<img src='img/"+a.type+(a.white?"w":"b")+".png'/>",o.className="piece "+(a.white?"w ":"b "),o.style.left=i*t+"px",o.style.top=n*t+"px",o.setAttribute("x",i),o.setAttribute("y",n),this.cbElm.appendChild(o)}}},doMove:function(){},animateMove:function(e,t,i){var n=document.querySelector('.piece[x="'+e.x+'"][y="'+e.y+'"]'),a=h.cbsize/8,o=t.x*a,s=t.y*a,r=parseInt(n.style.left),c=parseInt(n.style.top),d=0,l=(o-r)/80,u=(s-c)/80;this.animInterval=setInterval(function(){n.style.left=r+d*l+"px",n.style.top=c+d*u+"px",80<++d&&(clearInterval(h.animInterval),n.style.left=o+"px",n.style.top=s+"px",i())},40)},reset:function(){},setTurn:function(e){e?document.querySelectorAll(".piece.w").forEach(function(e){e.draggable="true",e.ondragstart=function(e){var t=this.getAttribute("x"),i=this.getAttribute("y");e.dataTransfer.setData("text",JSON.stringify({x:t,y:i}))}}):document.querySelectorAll(".piece").forEach(function(e){e.draggable="false",e.ondragstart=null})},layout:function(){h.cbsize=Math.min(window.innerWidth-24,window.innerHeight-80),h.cbElm.style.width=h.cbsize+"px",h.cbElm.style.height=h.cbsize+"px",h.cbElm.style.backgroundSize=h.cbsize/4+"px",h.draw(),h.setTurn(bchess.whiteToPlay)}};"undefined"==typeof TouchEvent&&(TouchEvent=function(){});var s={mouse:new THREE.Vector2,load:function(r){var c=this;if(document.getElementById("ui2d").style.display="none",c.sceneElm=document.getElementById("scene"),c.sceneElm.style.display="block",c.scene)r();else{c.scene=new THREE.Scene,c.sceneElm.onmousedown=c.onMouseDown,c.sceneElm.onmousemove=c.onMouseMove,c.sceneElm.onmouseup=c.onMouseUp,c.sceneElm.ontouchstart=c.onMouseDown,c.sceneElm.ontouchmove=c.onMouseMove,c.sceneElm.ontouchend=c.onMouseUp;var t=new THREE.JSONLoader;c.geos={};var i=.42;t.load("scene/pion.json",function(e){e.scale(i,i,i),c.geos.pion=e,t.load("scene/tour.json",function(e){e.scale(i,i,i),c.geos.tour=e,t.load("scene/cheval.json",function(e){e.scale(i,i,i),c.geos.cheval=e,t.load("scene/fou.json",function(e){e.scale(i,i,i),c.geos.fou=e,t.load("scene/dame.json",function(e){e.scale(i,i,i),c.geos.dame=e,t.load("scene/roi.json",function(e){e.rotateY(Math.PI/2),e.scale(i,i,i),c.geos.roi=e,(new THREE.TextureLoader).load("scene/wood.jpg",function(e){c.meshes=[];for(var t=new THREE.MeshPhongMaterial({color:15658734,map:e}),i=new THREE.MeshPhongMaterial({color:5592405,map:e}),n=0;n<8;n++)for(var a=0;a<8;a++){var o=bchess.board[n][a];if("empty"!=o.type&&c.geos[o.type]){o.x=n,o.y=a;var s=new THREE.Mesh(c.geos[o.type],o.white?t:i);s.position.set(-3.5+n,0,-3.5+a),s.castShadow=!0,s.rotation.y="cheval"==o.type?o.white?-Math.PI/2:Math.PI/2:0,s.userData.piece=JSON.parse(JSON.stringify(o)),c.meshes.push(s),c.scene.add(s)}}c.loadScene(r)})})})})})})})}},loadScene:function(i){var n=this;n.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),n.renderer.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),n.renderer.shadowMap.type=THREE.PCFSoftShadowMap,n.renderer.shadowMap.enabled=!0,n.renderer.shadowMap.renderReverseSided=!1,n.sceneElm.appendChild(n.renderer.domElement),n.aspect=window.innerWidth/window.innerHeight,n.camera=new THREE.PerspectiveCamera(38,n.aspect,.25,1e3),n.scene.add(n.camera),n.lookpoint=new THREE.Vector3(0,0,.12),n.layout(),n.scene.add(new THREE.AmbientLight(16777215,.58));var e=new THREE.PointLight(16777215,.66);e.position.set(6,10,6),n.scene.add(e);var t=new THREE.PointLight(16777215,.23);t.position.set(-5,5,-5),n.scene.add(t);e.castShadow=!0,e.shadow.mapSize.width=512,e.shadow.mapSize.height=512,e.shadow.camera.near=.01,e.shadow.camera.far=1e3,e.shadow.camera.left=-.2,e.shadow.camera.right=.2,e.shadow.camera.top=.2,e.shadow.camera.bottom=-.2;var a=new THREE.ShadowMaterial({opacity:.18}),o=new THREE.PlaneGeometry(12,12);o.rotateX(-Math.PI/2);var s=new THREE.Mesh(o,a);s.receiveShadow=!0,n.scene.add(s),(new THREE.TextureLoader).load("scene/cb.png",function(e){e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat.set(1,1);var t=new THREE.PlaneGeometry(8,8);t.rotateX(-Math.PI/2),n.planemesh=new THREE.Mesh(t,new THREE.MeshLambertMaterial({map:e,color:14342874})),n.planemesh.position.set(0,-.01,0),n.scene.add(n.planemesh),n.raycaster=new THREE.Raycaster,i()})},onMouseDown:function(e){if(bchess.whiteToPlay){var t=0,i=0;if(e instanceof TouchEvent){var n=e.changedTouches[0];t=n.clientX,i=n.clientY}else t=e.clientX,i=e.clientY;s.mouse.x=t/window.innerWidth*2-1,s.mouse.y=-i/window.innerHeight*2+1,s.raycaster.setFromCamera(s.mouse,s.camera);var a=s.raycaster.intersectObject(s.planemesh)[0];if(a){t=Math.floor(8*a.uv.x),i=7-Math.floor(8*a.uv.y);var o=bchess.board[t][i];"empty"!=o.type&&o.white?(s.draggedPiece=o,s.draggedMesh=s.meshes.filter(function(e){return e.userData.piece.x==t&&e.userData.piece.y==i})[0],s.draw()):s.draggedPiece=null}}},onMouseMove:function(e){if(s.draggedPiece){var t=0,i=0;if(e instanceof TouchEvent){var n=e.changedTouches[0];t=n.clientX,i=n.clientY}else t=e.clientX,i=e.clientY;s.mouse.x=t/window.innerWidth*2-1,s.mouse.y=-i/window.innerHeight*2+1,s.raycaster.setFromCamera(s.mouse,s.camera);var a=s.raycaster.intersectObject(s.planemesh)[0];a&&(s.draggedMesh.position.set(a.point.x,0,a.point.z),s.draw())}},onMouseUp:function(e){if(s.draggedPiece){var t=0,i=0;if(e instanceof TouchEvent){var n=e.changedTouches[0];t=n.clientX,i=n.clientY}else t=e.clientX,i=e.clientY;s.mouse.x=t/window.innerWidth*2-1,s.mouse.y=-i/window.innerHeight*2+1,s.raycaster.setFromCamera(s.mouse,s.camera);var a=s.raycaster.intersectObject(s.planemesh)[0];if(a){t=Math.floor(8*a.uv.x),i=7-Math.floor(8*a.uv.y);bchess.requestUserMove({x:s.draggedPiece.x,y:s.draggedPiece.y},{x:t,y:i})}}s.draggedPiece=null},draw:function(e){this.renderer.render(this.scene,this.camera)},doMove:function(t,i){this.movedMesh=s.meshes.filter(function(e){return e.userData.piece.x==t.x&&e.userData.piece.y==t.y})[0];var e=s.meshes.filter(function(e){return e.userData.piece.x==i.x&&e.userData.piece.y==i.y})[0];e&&this.animateEaten(e),this.movedMesh.userData.piece.x=i.x,this.movedMesh.userData.piece.y=i.y,this.movedMesh.position.set(-3.5+this.movedMesh.userData.piece.x,0,-3.5+this.movedMesh.userData.piece.y)},animateMove:function(t,i,e){this.movedMesh=s.meshes.filter(function(e){return e.userData.piece.x==t.x&&e.userData.piece.y==t.y})[0];var n=s.meshes.filter(function(e){return e.userData.piece.x==i.x&&e.userData.piece.y==i.y})[0];n&&this.animateEaten(n,!0);var a=0;this.animTarget=new THREE.Vector3,this.animTarget.set(-3.5+i.x,0,-3.5+i.y),this.animDir=new THREE.Vector3,this.animDir.copy(this.animTarget).sub(this.movedMesh.position).multiplyScalar(1/80),this.animInterval=setInterval(function(){a++,s.movedMesh.position.add(s.animDir),80<a&&(s.movedMesh.userData.piece.x=i.x,s.movedMesh.userData.piece.y=i.y,s.movedMesh.position.set(-3.5+s.movedMesh.userData.piece.x,0,-3.5+s.movedMesh.userData.piece.y),clearInterval(s.animInterval),e()),s.draw()},40)},animateEaten:function(e,t){var i=0;this.animEatInterval=setInterval(function(){i++,e.position.y+=.025,120<i&&(e.visible=!1,e.userData.piece.x=-1,e.userData.piece.y=-1,clearInterval(s.animEatInterval)),t||s.draw()},40)},setTurn:function(e){},reset:function(){this.meshes.forEach(function(e){e.position.set(-3.5+e.userData.piece.x,0,-3.5+e.userData.piece.y)})},layout:function(){if(s.renderer&&s.renderer.setSize(window.innerWidth,window.innerHeight),s.camera){var e=window.innerWidth,t=Math.max(7.8,30-.0126*Math.pow(e,1.2));console.log(t),s.camera.position.set(0,1.4*t,t),s.camera.lookAt(s.lookpoint),s.aspect=window.innerWidth/window.innerHeight,s.camera.aspect=s.aspect,s.camera.updateProjectionMatrix(),s.draw()}}};